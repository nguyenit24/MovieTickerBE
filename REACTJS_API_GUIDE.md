# üé¨ API Guide - H·ªá th·ªëng ƒê·∫∑t V√© Xem Phim (ReactJS)

## üìã Quy tr√¨nh ƒë·∫∑t v√© ho√†n ch·ªânh t·ª´ A-Z

### üéØ T·ªïng quan Flow
1. **ƒê·∫∑t v√©** ‚Üí Nh·∫≠n th√¥ng tin booking v·ªõi tr·∫°ng th√°i `PROCESSING`
2. **T·∫°o thanh to√°n** ‚Üí Nh·∫≠n URL/QR code thanh to√°n 
3. **Thanh to√°n** ‚Üí H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i
4. **Ki·ªÉm tra k·∫øt qu·∫£** ‚Üí Polling API ƒë·ªÉ x√°c nh·∫≠n tr·∫°ng th√°i

---

## üõ†Ô∏è API Endpoints

### 1. ƒê·∫∑t v√© (Book Tickets)
**Endpoint:** `POST /api/ve`

**Request:**
```json
{
  "maSuatChieu": "sc-123",
  "maGheList": ["ghe-001", "ghe-002"],
  "maPhim": "phim-001",
  "maKhuyenMai": "km-001",
  "phuongThucThanhToan": "VNPAY",
  "dichVuList": [
    {
      "maDv": "dv-001", 
      "soLuong": 2
    }
  ]
}
```

**Response Success (200):**
```json
{
  "code": 200,
  "message": "ƒê·∫∑t v√© th√†nh c√¥ng - ƒêang x·ª≠ l√Ω",
  "data": {
    "maHD": "HD1760164690255697",
    "ngayLap": "2025-10-11T13:38:10.2556321",
    "tongTien": 184000.0,
    "phuongThucThanhToan": "VNPAY",
    "trangThai": "PROCESSING",
    "maGiaoDich": "GD1760164690249",
    "ghiChu": "T·ªïng ti·ªÅn v√©: 180000 VND\\nPh·ª• thu d·ªãch v·ª•: 50000 VND\\nGi·∫£m gi√°: 46000 VND\\nT·ªïng c·ªông: 184000 VND",
    "danhSachVe": [
      {
        "maVe": "VE-1760164690266586",
        "tenPhim": "The Hangover",
        "tenPhongChieu": "Ph√≤ng 3",
        "tenGhe": "A01",
        "thoiGianChieu": "2025-10-17T20:14:00",
        "ngayDat": "2025-10-11T13:38:10.2667541",
        "thanhTien": 90000.0,
        "trangThai": "PROCESSING",
        "maHoaDon": "HD1760164690255697"
      }
    ],
    "tenNguoiDung": null
  }
}
```

### 2. T·∫°o thanh to√°n VNPAY
**Endpoint:** `POST /api/payment/vn_pay/create`

**Request:**
```json
{
  "amount": 184000,
  "orderId": "HD1760164690255697"
}
```

**Response (201):**
```json
{
  "code": 201,
  "message": "T·∫°o thanh to√°n th√†nh c√¥ng",
  "data": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?vnp_Amount=18400000&..."
}
```

### 3. T·∫°o thanh to√°n MOMO
**Endpoint:** `POST /api/payment/momo/create`

**Request:**
```json
{
  "amount": 184000,
  "orderId": "HD1760164690255697"
}
```

**Response (201):**
```json
{
  "code": 201,
  "message": "T·∫°o thanh to√°n th√†nh c√¥ng",
  "data": {
    "payUrl": "https://payment.momo.vn/...",
    "qrCodeUrl": "data:image/png;base64,..."
  }
}
```

### 4. Callback thanh to√°n (Auto t·ª´ gateway)
**VNPAY Callback:** `GET /api/payment/vn_pay/payment_info`
**MOMO Callback:** `GET /api/payment/momo/payment_info`

**VNPAY Response Success:**
```json
{
  "code": 200,
  "message": "Thanh to√°n th√†nh c√¥ng",
  "data": {
    "transactionNo": "15198513",
    "transactionDate": "20251010215344",
    "responseCode": "00",
    "orderId": "HD1760164690255697",
    "status": "SUCCESS"
  }
}
```

### 5. Ki·ªÉm tra tr·∫°ng th√°i thanh to√°n
**Endpoint:** `GET /api/payment/status/{orderId}`

**Response Success (PAID):**
```json
{
  "code": 200,
  "message": "L·∫•y tr·∫°ng th√°i th√†nh c√¥ng",
  "data": {
    "orderId": "HD1760164690255697",
    "status": "PAID",
    "transactionNo": "15198513",
    "transactionDate": "20251010215344",
    "responseCode": "00",
    "paymentStatus": "SUCCESS"
  }
}
```

**Response Processing:**
```json
{
  "code": 200,
  "message": "L·∫•y tr·∫°ng th√°i th√†nh c√¥ng",
  "data": {
    "orderId": "HD1760164690255697",
    "status": "PROCESSING",
    "transactionNo": null,
    "transactionDate": null,
    "responseCode": null,
    "paymentStatus": "PENDING"
  }
}
```

---

## ‚öõÔ∏è ReactJS Implementation

### üéØ Component Structure
```
BookingFlow/
‚îú‚îÄ‚îÄ BookingForm.jsx          # Form ƒë·∫∑t v√©
‚îú‚îÄ‚îÄ PaymentSelection.jsx     # Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
‚îú‚îÄ‚îÄ PaymentProcessing.jsx    # X·ª≠ l√Ω thanh to√°n
‚îú‚îÄ‚îÄ PaymentSuccess.jsx       # K·∫øt qu·∫£ th√†nh c√¥ng
‚îî‚îÄ‚îÄ PaymentFailed.jsx        # K·∫øt qu·∫£ th·∫•t b·∫°i
```

### üìù Main Booking Component

```javascript
import React, { useState, useEffect } from 'react';

const BookingFlow = () => {
  const [currentStep, setCurrentStep] = useState('booking');
  const [orderData, setOrderData] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState('VNPAY');
  const [paymentStatus, setPaymentStatus] = useState('PENDING');

  // 1. ƒê·∫∑t v√©
  const handleBooking = async (bookingData) => {
    try {
      const response = await fetch('/api/ve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bookingData)
      });

      const result = await response.json();

      if (result.code === 200) {
        setOrderData(result.data);
        localStorage.setItem('currentOrderId', result.data.maHD);
        setCurrentStep('payment');
      } else {
        alert(result.message);
      }
    } catch (error) {
      alert('L·ªói k·∫øt n·ªëi: ' + error.message);
    }
  };

  // 2. T·∫°o thanh to√°n
  const handlePayment = async () => {
    const endpoint = paymentMethod === 'VNPAY' 
      ? '/api/payment/vn_pay/create' 
      : '/api/payment/momo/create';

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: orderData.tongTien,
          orderId: orderData.maHD
        })
      });

      const result = await response.json();

      if (result.code === 201) {
        if (paymentMethod === 'VNPAY') {
          // Redirect t·ªõi VNPAY
          window.location.href = result.data;
        } else {
          // Hi·ªÉn th·ªã QR MOMO v√† start polling
          setCurrentStep('processing');
          startPaymentPolling(orderData.maHD);
        }
      } else {
        alert('L·ªói t·∫°o thanh to√°n: ' + result.message);
      }
    } catch (error) {
      alert('L·ªói t·∫°o thanh to√°n: ' + error.message);
    }
  };

  // 3. Polling ki·ªÉm tra tr·∫°ng th√°i
  const checkPaymentStatus = async (orderId) => {
    try {
      const response = await fetch(\`/api/payment/status/\${orderId}\`);
      const result = await response.json();

      if (result.code === 200) {
        return result.data;
      }
      return { paymentStatus: 'ERROR' };
    } catch (error) {
      return { paymentStatus: 'ERROR' };
    }
  };

  const startPaymentPolling = (orderId) => {
    const pollInterval = setInterval(async () => {
      const status = await checkPaymentStatus(orderId);

      if (status.paymentStatus === 'SUCCESS') {
        clearInterval(pollInterval);
        setPaymentStatus('SUCCESS');
        setCurrentStep('success');
        localStorage.removeItem('currentOrderId');
      } else if (status.paymentStatus === 'FAILED') {
        clearInterval(pollInterval);
        setPaymentStatus('FAILED');
        setCurrentStep('failed');
      }
    }, 3000); // Poll m·ªói 3 gi√¢y

    // Timeout sau 10 ph√∫t
    setTimeout(() => {
      clearInterval(pollInterval);
      if (paymentStatus === 'PENDING') {
        setPaymentStatus('TIMEOUT');
        setCurrentStep('failed');
      }
    }, 600000);
  };

  // 4. Handle return t·ª´ VNPAY
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const vnpResponseCode = urlParams.get('vnp_ResponseCode');
    const orderId = localStorage.getItem('currentOrderId');

    if (vnpResponseCode && orderId) {
      setCurrentStep('processing');
      startPaymentPolling(orderId);
    }
  }, []);

  return (
    <div className="booking-flow">
      {currentStep === 'booking' && (
        <BookingForm onSubmit={handleBooking} />
      )}
      
      {currentStep === 'payment' && (
        <PaymentSelection 
          orderData={orderData}
          selectedMethod={paymentMethod}
          onMethodChange={setPaymentMethod}
          onProceed={handlePayment}
        />
      )}
      
      {currentStep === 'processing' && (
        <PaymentProcessing 
          orderId={orderData?.maHD}
          paymentMethod={paymentMethod}
        />
      )}
      
      {currentStep === 'success' && (
        <PaymentSuccess orderData={orderData} />
      )}
      
      {currentStep === 'failed' && (
        <PaymentFailed 
          orderData={orderData}
          reason={paymentStatus}
          onRetry={() => setCurrentStep('payment')}
        />
      )}
    </div>
  );
};

export default BookingFlow;
```

### üí≥ Payment Selection Component

```javascript
const PaymentSelection = ({ orderData, selectedMethod, onMethodChange, onProceed }) => {
  return (
    <div className="payment-selection">
      <h2>Th√¥ng tin ƒë∆°n h√†ng</h2>
      <div className="order-summary">
        <p>M√£ ƒë∆°n h√†ng: {orderData.maHD}</p>
        <p>T·ªïng ti·ªÅn: {orderData.tongTien.toLocaleString()} VND</p>
        <p>Tr·∫°ng th√°i: {orderData.trangThai}</p>
      </div>

      <h3>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h3>
      <div className="payment-methods">
        <label>
          <input 
            type="radio" 
            value="VNPAY"
            checked={selectedMethod === 'VNPAY'}
            onChange={(e) => onMethodChange(e.target.value)}
          />
          VNPAY
        </label>
        <label>
          <input 
            type="radio" 
            value="MOMO"
            checked={selectedMethod === 'MOMO'}
            onChange={(e) => onMethodChange(e.target.value)}
          />
          MOMO
        </label>
      </div>

      <button onClick={onProceed} className="proceed-btn">
        Thanh to√°n
      </button>
    </div>
  );
};
```

### ‚è≥ Payment Processing Component

```javascript
const PaymentProcessing = ({ orderId, paymentMethod }) => {
  const [timeLeft, setTimeLeft] = useState(600); // 10 ph√∫t

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft(prev => prev > 0 ? prev - 1 : 0);
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return \`\${mins}:\${secs.toString().padStart(2, '0')}\`;
  };

  return (
    <div className="payment-processing">
      <h2>ƒêang x·ª≠ l√Ω thanh to√°n...</h2>
      <p>M√£ ƒë∆°n h√†ng: {orderId}</p>
      <p>Ph∆∞∆°ng th·ª©c: {paymentMethod}</p>
      <p>Th·ªùi gian c√≤n l·∫°i: {formatTime(timeLeft)}</p>
      
      <div className="loading-spinner">
        <div className="spinner"></div>
      </div>
      
      <p>Vui l√≤ng kh√¥ng ƒë√≥ng trang n√†y</p>
    </div>
  );
};
```

---

## üîÑ Tr·∫°ng th√°i & Error Handling

### üìä Mapping Tr·∫°ng th√°i
```javascript
const STATUS_MAPPING = {
  // Tr·∫°ng th√°i ƒë∆°n h√†ng
  'PROCESSING': 'ƒêang x·ª≠ l√Ω',
  'PAID': 'ƒê√£ thanh to√°n', 
  'FAILED': 'Th·∫•t b·∫°i',
  'CANCELLED': 'ƒê√£ h·ªßy',
  'EXPIRED': 'H·∫øt h·∫°n',
  
  // Tr·∫°ng th√°i thanh to√°n
  'SUCCESS': 'Th√†nh c√¥ng',
  'PENDING': 'ƒêang ch·ªù',
  'TIMEOUT': 'H·∫øt th·ªùi gian'
};
```

### üö® Error Handling Utils
```javascript
const handleApiError = (error, context) => {
  console.error(\`Error in \${context}:\`, error);
  
  // Show user-friendly message
  const message = error.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i';
  showNotification(message, 'error');
  
  // Log for debugging
  if (process.env.NODE_ENV === 'development') {
    console.table(error);
  }
};

const showNotification = (message, type = 'info') => {
  // Implementation v·ªõi toast/notification library
  toast(message, { type });
};
```

---

## üéØ Tips & Best Practices

### ‚úÖ Frontend Best Practices:
1. **localStorage backup** - L∆∞u orderId ƒë·ªÉ recovery
2. **Countdown timer** - Hi·ªÉn th·ªã th·ªùi gian c√≤n l·∫°i
3. **Polling strategy** - Check status m·ªói 3-5 gi√¢y
4. **Error boundaries** - Wrap components v·ªõi error handling
5. **Loading states** - Show spinner khi call API
6. **Back button handling** - Handle browser navigation
7. **Responsive design** - Mobile-friendly payment flow

### üîí Security:
1. **Validate inputs** - Client-side validation tr∆∞·ªõc khi submit
2. **HTTPS only** - T·∫•t c·∫£ payment calls qua HTTPS
3. **No sensitive data** - Kh√¥ng l∆∞u payment info trong localStorage
4. **Timeout handling** - Clear timers khi unmount component

### üì± UX Improvements:
1. **Progress indicator** - Show steps 1-2-3-4
2. **Confirmation modals** - X√°c nh·∫≠n tr∆∞·ªõc khi proceed
3. **Retry mechanism** - Cho ph√©p th·ª≠ l·∫°i khi l·ªói
4. **Success animation** - Celebrate khi th√†nh c√¥ng
5. **Clear error messages** - Specific error cho t·ª´ng case

---

## üß™ Testing Scenarios

### Test Cases:
1. **Happy Path** - ƒê·∫∑t v√© ‚Üí Thanh to√°n ‚Üí Th√†nh c√¥ng
2. **Payment Failed** - ƒê·∫∑t v√© ‚Üí Thanh to√°n th·∫•t b·∫°i
3. **Timeout** - ƒê·∫∑t v√© ‚Üí Kh√¥ng thanh to√°n trong 10 ph√∫t
4. **Network Error** - M·∫•t k·∫øt n·ªëi during polling
5. **Browser Refresh** - Refresh page during payment
6. **Back Button** - Browser back during flow

V·ªõi guide n√†y, team FE ReactJS c√≥ th·ªÉ implement ho√†n ch·ªânh flow ƒë·∫∑t v√© v·ªõi UX t·ªët v√† error handling ƒë·∫ßy ƒë·ªß! üöÄ